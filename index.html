<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IIIRN-SHOPPING ระบบร้านค้า</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
    <style>
        @keyframes add-to-cart {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.2);
            }

            100% {
                transform: scale(1);
            }
        }

        .added-to-cart {
            animation: add-to-cart 0.5s ease-in-out;
        }

        @keyframes loading-text {
            0% {
                content: "โหลด..รายการสินค้า";
            }

            33% {
                content: "โหลด...รายการสินค้า";
            }

            66% {
                content: "โหลด....รายการสินค้า";
            }

            100% {
                content: "โหลด.....รายการสินค้า";
            }
        }

        .loading-animation::after {
            content: "โหลด..รายการสินค้า";
            animation: loading-text 1.5s infinite;
        }
    </style>
</head>

<body class="bg-yellow-50">
    <!-- ฟังก์ชันการแสดงรายการสินค้า -->
    <div id="product-selection" class="max-w-md mx-auto pt-20">
        <div class=" p-4 rounded-lg">
            <div class="fixed top-0 left-0 w-full bg-white shadow z-50">
                <div class="flex justify-between items-center p-4">
                    <div class="flex items-center">
                        <div class="w-12 h-12 rounded-lg items-center">
                            <img src="https://lh5.googleusercontent.com/d/17VYrYx47MjT67L3nQ_PUsiABUPN00DjX"
                                alt="Profile Image" id="profileImage" class="w-12 h-12 bg-white rounded-lg">
                        </div>
                        <div class="pl-4">
                            <p class="text-slate-400 text-xs">ยินดีต้อนรับ</p>
                            <input type="text"
                                class="input-field bg-green-500 w-32 text-green-400 text-lg font-bold bg-opacity-0"
                                id="displayName" name="displayName" readonly>
                        </div>
                    </div>
                    <div class="flex items-center">

                        <button id="go-to-cart"
                            class="bg-green-500 text-white text-md py-2 px-4 flex items-center gap-2 rounded-lg ml-4">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"
                                color="#ffffff" fill="none">
                                <path
                                    d="M11.5 8H20.196C20.8208 8 21.1332 8 21.3619 8.10084C22.3736 8.5469 21.9213 9.67075 21.7511 10.4784C21.7205 10.6235 21.621 10.747 21.4816 10.8132C20.9033 11.0876 20.4982 11.6081 20.3919 12.2134L19.7993 15.5878C19.5386 17.0725 19.4495 19.1943 18.1484 20.2402C17.1938 21 15.8184 21 13.0675 21H10.9325C8.18162 21 6.8062 21 5.8516 20.2402C4.55052 19.1942 4.46138 17.0725 4.20066 15.5878L3.60807 12.2134C3.50177 11.6081 3.09673 11.0876 2.51841 10.8132C2.37896 10.747 2.27952 10.6235 2.24894 10.4784C2.07874 9.67075 1.6264 8.5469 2.63812 8.10084C2.86684 8 3.17922 8 3.80397 8H7.5"
                                    stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
                                <path d="M14 12L10 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                                    stroke-linejoin="round" />
                                <path d="M6.5 11L10 3M15 3L17.5 8" stroke="currentColor" stroke-width="1.5"
                                    stroke-linecap="round" />
                            </svg>
                            0
                        </button>
                    </div>
                </div>
            </div>


            <div>
                <div class="flex">
                    <div id="tab-nav" class="flex overflow-x-auto space-x-4 py-2">
                        <!-- ฟังก์ชันการแสดงหมวดหมู่สินค้า -->
                    </div>
                </div>
                <!-- เพิ่มช่องค้นหาสินค้า -->
                <div class="relative ">
                    <input type="text" id="search-input" placeholder="ค้นหาสินค้า"
                        class="w-full px-4 py-2 border border-yellow-400 rounded-lg ">
                </div>
                <div id="product-list" class="text-center">
                </div>
                <div id="load-more-container" class="text-center m-4 hidden">
                    <button id="load-more" class="bg-white px-4 py-2 rounded-lg">เพิ่มเติม</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ฟังก์ชันการแสดงตะกร้าสินค้า -->
    <div id="cart-view" class="max-w-md mx-auto pt-20 hidden">
        <div class="bg-white rounded-lg p-4">
            <div class="fixed top-0 left-0 w-full bg-white shadow z-50">
                <div class="flex justify-between items-center p-4">
                    <h2 class="text-md font-semibold">ตะกร้าสินค้า</h2>
                    <div id="back-to-products"
                        class="bg-white opacitywhite text-center font-bold py-2 w-36 border rounded-lg">กลับ ร้านค้า
                    </div>
                </div>
            </div>

            <div id="cart-items" class="bg-white rounded-lg"></div>

            <div class="pt-4">
                <div class="flex justify-between items-center mb-4">
                    <label for="shipping-options" class="text-sm">เลือกวิธีการจัดส่ง</label>
                    <select id="shipping-options" class="bg-white border border-gray-400 rounded-lg p-2">
                        <option value="A00000">ธรรมดา (30 บาท)</option>
                        <option value="A00001">ด่วน (50 บาท)</option>
                        <option value="A00002">ขนส่ง (เรียกเก็บภายหลัง)</option>
                        <option value="A00003">ส่งฟรี (สั่งซื้อครบ 500 บาท)</option>
                    </select>
                </div>
                <div class="flex justify-between items-center mb-4">
                    <span class="text-md font-semibold">ค่าจัดส่ง</span>
                    <span id="shipping-cost" class="text-md text-gray-400">5.00 บาท</span>
                </div>
                <div class="flex justify-between items-center mb-4">
                    <span class="text-md font-semibold">ราคารวมสินค้า</span>
                    <span id="total-price" class="text-md text-gray-400">0.00 บาท</span>
                </div>

                <div class="flex justify-between items-center mb-4">
                    <span class="text-md font-semibold">ราคารวมทั้งหมด</span>
                    <span id="grand-total" class="text-lg text-amber-600 font-semibold">0.00 บาท</span>
                </div>
            </div>


            <button id="go-to-shipping"
                class="w-full bg-green-500 text-white p-4 rounded-lg font-semibold hidden">ถัดไป</button>
        </div>
    </div>

    <!-- ฟังก์ชันการแสดงข้อมูลจัดส่ง -->
    <div id="shipping-info" class="max-w-md mx-auto pt-20 hidden">
        <div class="p-4">
            <!-- ส่วนหัวของการจัดส่ง -->
            <div class="fixed top-0 left-0 w-full bg-white shadow z-50">
                <!-- เพิ่ม margin-top เพื่อให้ไม่ทับกับ header อื่น -->
                <div class="flex justify-between items-center p-4">
                    <h2 class="text-md font-semibold">การจัดส่ง</h2>
                    <button id="back-to-cart"
                        class="bg-white opacitywhite text-center font-bold py-2 w-36 border rounded-lg">กลับ
                        ตะกร้าสินค้า</button>
                </div>
            </div>
            <form id="shipping-form">
                <div id="loading-container">
                    <div id="loading-icon"></div>
                    <div class="text-center">กำลังค้นหารายชื่อ...</div>
                </div>
                <div id="form-container">
                    <div class="mb-4">
                        <label for="username" class="block text-gray-700">ชื่อ:</label>
                        <input type="text" id="username" placeholder="Name"
                            class="block w-full mb-2 p-2 border rounded-lg" required />
                    </div>
                    <div class="mb-4">
                        <label for="contact" class="block text-gray-700">เบอร์ติดต่อ:</label>
                        <input type="text" id="contact" placeholder="Contact"
                            class="block w-full mb-2 p-2 border rounded-lg" required />
                    </div>
                    <div class="mb-4">
                        <label for="address" class="block text-gray-700">ที่อยู่:</label>
                        <textarea id="address" placeholder="Address" class="block w-full mb-2 p-2 border rounded-lg"
                            style="height: 150px;" required></textarea>

                    </div>
                    <div class="mb-4">
                        <label for="note" class="block text-gray-700">หมายเหตุ:</label>
                        <textarea id="note" placeholder="หมายเหตุเพิ่มเติม"
                            class="block w-full mb-2 p-2 border rounded-lg" style="height: 100px;"></textarea>
                    </div>

                    <div class="mb-4">
                        <input type="checkbox" id="save-info" class="mr-2">
                        <label for="save-info"
                            class="text-gray-700">บันทึกชื่อและที่อยู่สำหรับการใช้งานครั้งถัดไป</label>
                    </div>
                    <input type="hidden" id="userlineid" name="userlineid">
                </div>
                <button type="submit" class="bg-green-500 text-white p-4 w-full rounded-lg mt-4">สั่งซื้อสินค้า</button>
            </form>
        </div>
    </div>

    <!-- ฟังก์ชันแสดงรายละเอียดการสั่งซื้อ -->
    <div id="order-details-modal" class="fixed z-10 inset-0 overflow-y-auto hidden ">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
            </div>
            <div class=" rounded-lg overflow-hidden  transform transition-all w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">รายละเอียดสั่งซื้อ</h3>
                    <div class="mt-2">
                        <div id="order-details-content" class="bg-gray-100 p-4 rounded-lg"></div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button id="confirm-order"
                        class="w-full inline-flex justify-center rounded-lg border border-transparent  px-4 py-4 bg-blue-500 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">ยืนยันการสั่งซื้อ</button>
                    <button id="close-modal"
                        class="mt-3 w-full inline-flex justify-center rounded-lg border border-gray-300  px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:w-auto sm:text-sm">ยกเลิก</button>
                    <div id="order-status" class="px-4 py-3 sm:px-6 text-center text-sm hidden"></div>

                </div>
            </div>
        </div>
    </div>

    <script>
        // ฟังก์ชันตั้งค่า
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyf0WoFSleskxz34NbKuUrgI5HW5_DuX4qOkhmw2Fv7a43fGAmyE83MKNCItjQMWoRI/exec";
        const WEB_MEMBER_APP_URL = 'https://script.google.com/macros/s/AKfycbzmglQHTa1C7i3Dvm_xZnCKm0DiqB2Y2QjAlJIw-UEHTCI4XuEFH3kZCGQm2nd3xEc/exec';
        const LIFF_ID = '2001192277-ZgEjRJAG'; // Liff ID

        // ตัวเลือกการจัดส่ง
        const shippingOptions = [
            {
                id: 'A00000',
                name: 'ค่าจัดส่งธรรมดา',
                Price: 30,
                size: 'ปกติ 1-2 วัน',
                quantity: 1,
                'img-product': 'https://via.placeholder.com/40?text=Ship'
            },
            {
                id: 'A00001',
                name: 'ค่าจัดส่งด่วน',
                Price: 50,
                size: 'ส่งด่วน 1-2 ชั่วโมง',
                quantity: 1,
                'img-product': 'https://via.placeholder.com/40?text=Express'
            },
            {
                id: 'A00002',
                name: 'ส่งผ่านขนส่ง',
                Price: 0,
                size: '100',
                quantity: 1,
                'img-product': 'https://via.placeholder.com/40?text=Transport'
            },
            {
                id: 'A00003',
                name: 'ส่งฟรี',
                Price: 0,
                size: 'ฟรี',
                quantity: 1,
                'img-product': 'https://via.placeholder.com/40?text=Free'
            }
        ];

        // ตั้งค่าการจัดส่งเริ่มต้น
        let selectedShipping = shippingOptions[0];


        // เมื่อผู้ใช้เลือกการจัดส่งจาก dropdown
        document.getElementById('shipping-options').addEventListener('change', function (event) {
            const selectedId = event.target.value;
            selectedShipping = shippingOptions.find(option => option.id === selectedId);

            // เพิ่มค่าจัดส่งใหม่ลงในตะกร้าเฉพาะเมื่อมีการเลือกจาก dropdown
            resetShippingCost();
            if (selectedShipping.Price > 0) {
                cart.push({ ...selectedShipping, quantity: 1 }); // เพิ่มค่าจัดส่งที่เลือกลงในตะกร้า
            }

            updateTotalPrice(); // อัปเดตราคารวมใหม่หลังจากเปลี่ยนการจัดส่ง
        });


        function updateTotalPrice() {
            const productTotal = cart.reduce((total, item) => total + (item.Price * item.quantity), 0);
            const grandTotal = productTotal + selectedShipping.Price;

            // อัปเดตราคาใน HTML
            document.getElementById('total-price').textContent = `${productTotal.toFixed(2)} บาท`;
            document.getElementById('shipping-cost').textContent = `${selectedShipping.Price.toFixed(2)} บาท`;
            document.getElementById('grand-total').textContent = `${grandTotal.toFixed(2)} บาท`;

            // เรียกฟังก์ชันตรวจสอบการส่งฟรี
            checkForFreeShipping();
        }



        function checkForFreeShipping() {
            const productTotal = cart.reduce((total, item) => total + (item.Price * item.quantity), 0);
            const shippingDropdown = document.getElementById('shipping-options');
            const freeShippingOption = shippingOptions.find(option => option.id === 'A00003'); // ตัวเลือกส่งฟรี

            if (productTotal >= 500) {
                // เปลี่ยนเป็นการจัดส่งฟรีโดยอัตโนมัติ
                selectedShipping = freeShippingOption;

                // อัปเดต dropdown ให้แสดง 'ส่งฟรี'
                shippingDropdown.value = 'A00003';

                // ซ่อนตัวเลือกอื่น
                Array.from(shippingDropdown.options).forEach(option => {
                    if (option.value !== 'A00003') {
                        option.style.display = 'none';
                    }
                });
            } else {
                // แสดงตัวเลือกอื่นๆ
                Array.from(shippingDropdown.options).forEach(option => {
                    option.style.display = 'block';
                });

                // ตั้งค่ากลับเป็นตัวเลือกเริ่มต้นหากยอดไม่ถึง 500
                selectedShipping = shippingOptions[0];
                shippingDropdown.value = selectedShipping.id;
            }

            updateTotalPrice(); // อัปเดตราคารวมใหม่หลังจากเปลี่ยนการจัดส่ง
        }




        // เริ่มการทำงานเมื่อโหลดหน้าเว็บ
        window.onload = async function () {
             await initializeLiff(); // เรียกใช้งาน LIFF
            currentTab = 'All'; // ตั้งค่า currentTab เป็น 'All' โดยค่าเริ่มต้น

            fetchProducts(); // ดึงข้อมูลสินค้า
        };


        // ฟังก์ชันเริ่มต้นการใช้งาน LIFF
        async function initializeLiff() {
            try {
                await liff.init({ liffId: `${LIFF_ID}` }); // ใช้ Liff ID ของคุณ
                if (liff.isLoggedIn()) {
                    showLoading(true); // แสดงหน้าจอโหลดข้อมูล
                    getUserProfile(); // ดึงข้อมูลโปรไฟล์ผู้ใช้
                } else {
                    liff.login(); // หากผู้ใช้ยังไม่ได้เข้าสู่ระบบให้เข้าสู่ระบบ
                }
            } catch (error) {
                console.error('Error initializing LIFF:', error); // แสดงข้อผิดพลาดถ้า LIFF เริ่มต้นไม่สำเร็จ
            }
        }

        // ฟังก์ชันสำหรับดึงข้อมูลโปรไฟล์ผู้ใช้
        async function getUserProfile() {
            try {
                const profile = await liff.getProfile(); // ดึงข้อมูลโปรไฟล์ผู้ใช้
                const userId = profile.userId;
                document.getElementById('userlineid').value = userId; // เก็บค่า user ID
                document.getElementById('displayName').value = profile.displayName;
                document.getElementById('profileImage').src = profile.pictureUrl || DEFAULT_IMAGE_URL;

                await fetchData(userId); // เรียกใช้ฟังก์ชันดึงข้อมูล
            } catch (error) {
                console.error('Error getting profile data:', error); // หากเกิดข้อผิดพลาดในการดึงข้อมูลโปรไฟล์
            } finally {
                showLoading(false); // ซ่อนหน้าจอโหลดข้อมูลเมื่อเสร็จสิ้น
            }
        }

        // ฟังก์ชันดึงข้อมูลจาก API
        async function fetchData(userId) {
            try {
                const response = await fetch(WEB_MEMBER_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'fetchData', userId: userId }) // ส่ง userId เพื่อดึงข้อมูล
                });
                const data = await response.json();

                // ตรวจสอบข้อมูลที่ดึงมา
                console.log('Data fetched:', data);

                if (data) { // หากมีข้อมูลให้แสดง
                    displayData(data);
                } else {
                    console.log('No data found for userId:', userId); // หากไม่พบข้อมูล
                }
            } catch (error) {
                console.error('Error fetching data:', error); // แสดงข้อผิดพลาดหากการดึงข้อมูลล้มเหลว
            }
        }

        // ฟังก์ชันแสดงข้อมูลผู้ใช้
        function displayData(row) {
            console.log('Displaying data:', row);

            document.getElementById('username').value = row.Name || ''; // ชื่อผู้ใช้
            document.getElementById('address').value = row.Address || '';  // ที่อยู่
            document.getElementById('contact').value = row.Contact || '';  // เบอร์ติดต่อ
        }

        // ฟังก์ชันแสดงหน้าจอโหลดข้อมูล
        function showLoading(isLoading) {
            const loadingContainer = document.getElementById('loading-container');
            const formContainer = document.getElementById('form-container');
            if (isLoading) {
                loadingContainer.style.display = 'block'; // แสดงการโหลดข้อมูล
                formContainer.style.display = 'none'; // ซ่อนฟอร์มข้อมูล
            } else {
                loadingContainer.style.display = 'none'; // ซ่อนการโหลดข้อมูล
                formContainer.style.display = 'block'; // แสดงฟอร์มข้อมูล
            }
        }

        const url = `${WEB_APP_URL}`; // Replace with your Web App URL
        let cart = [];
        let currentOrder = null;
        let currentTab = '';
        let currentPage = 0;
        const productsPerPage = 10;

        const productList = document.getElementById('product-list');
        const tabNav = document.getElementById('tab-nav');
        const goToCartBtn = document.getElementById('go-to-cart');
        const cartView = document.getElementById('cart-view');
        const productSelection = document.getElementById('product-selection');
        const backToProductsBtn = document.getElementById('back-to-products');
        const cartItems = document.getElementById('cart-items');
        const totalPriceEl = document.getElementById('total-price');
        const goToShippingBtn = document.getElementById('go-to-shipping');
        const shippingInfo = document.getElementById('shipping-info');
        const backToCartBtn = document.getElementById('back-to-cart');
        const shippingForm = document.getElementById('shipping-form');
        const orderDetailsModal = document.getElementById('order-details-modal');
        const orderDetailsContent = document.getElementById('order-details-content');
        const confirmOrderBtn = document.getElementById('confirm-order');
        const closeModalBtn = document.getElementById('close-modal');
        const orderStatusEl = document.getElementById('order-status');
        const loadMoreBtn = document.getElementById('load-more');
        const loadMoreContainer = document.getElementById('load-more-container');

        document.getElementById('search-input').addEventListener('input', searchProducts);
        loadMoreBtn.addEventListener('click', () => {
            currentPage += 1; // เพิ่มหน้าปัจจุบันเมื่อกดปุ่มโหลดเพิ่ม
            const products = JSON.parse(localStorage.getItem('products')); // ดึงสินค้าจาก localStorage
            renderProducts(products); // แสดงสินค้าที่เพิ่มขึ้น
        });

        // ฟังก์ชันค้นหาสินค้าตามชื่อ
        function searchProducts() {
            const query = document.getElementById('search-input').value.toLowerCase();
            const products = JSON.parse(localStorage.getItem('products'));
            const filteredProducts = products.filter(product => product.name.toLowerCase().includes(query));
            renderProducts(filteredProducts); // เรียกใช้ฟังก์ชันแสดงสินค้าที่มีการกรอง
        }

        // ฟังก์ชันสำหรับตั้งค่าราคาจัดส่งตามที่ต้องการ
        function setShippingCost(price) {
            selectedShipping.Price = price;
        }

        // ฟังก์ชันดึงข้อมูลสินค้า
        async function fetchProducts() {
            const loadingText = document.createElement('div');
            loadingText.className = 'loading-animation text-md pt-4 text-slate-700';
            productList.appendChild(loadingText);

            try {
                localStorage.removeItem('products');
                const response = await fetch(url);
                const products = await response.json();

                if (!products || products.length === 0) {
                    console.error("No products data received."); // หากไม่พบข้อมูลสินค้า
                    return;
                }

                localStorage.setItem('products', JSON.stringify(products)); // เก็บข้อมูลสินค้าใน localStorage
                currentTab = getFirstCategory(products); // กำหนดหมวดหมู่เริ่มต้นเป็นหมวดแรก
                renderProducts(products); // แสดงสินค้าบนหน้าเว็บ
                renderTabs(products); // แสดงหมวดหมู่
            } catch (error) {
                console.error('Error fetching products:', error); // แสดงข้อผิดพลาดหากเกิดข้อผิดพลาด
            } finally {
                productList.removeChild(loadingText); // เอาข้อความโหลดออกเมื่อเสร็จสิ้น
            }
        }

        // ฟังก์ชันดึงหมวดหมู่สินค้าแรก
        function getFirstCategory(products) {
            const categories = [...new Set(products.map(product => product.category || 'Uncategorized'))];
            return categories[0]; // หมวดหมู่แรกเป็นหมวดหมู่เริ่มต้น
        }

        // ฟังก์ชันแสดงแท็บหมวดหมู่สินค้า
        function renderTabs(products) {
            tabNav.innerHTML = ''; // เคลียร์แท็บเดิม
            let categories = [...new Set(products.map(product => product.category || 'Uncategorized'))];

            // ใส่หมวดหมู่ 'All' ไว้เป็นตัวเลือกแรกเสมอ
            categories = ['All', ...categories.filter(category => category !== 'All')];

            const tabContainer = document.createElement('div');
            tabContainer.classList.add('flex', 'space-x-4', 'overflow-x-auto', 'py-2');

            categories.forEach(category => {
                const tabButton = document.createElement('button');
                tabButton.classList.add('flex-shrink-0', 'px-1', 'py-1', 'pr-2', 'rounded-lg', 'focus:outline-none', 'flex', 'border', 'border-yellow-400', 'items-center', 'justify-start', 'space-x-2');

                // ตรวจสอบให้ 'All' ถูกทำเป็น active หาก currentTab เป็น 'All'
                if (category === 'All' && currentTab === 'All') {
                    tabButton.classList.add('active', 'bg-yellow-200', 'text-black');
                }

                const categoryImage = document.createElement('img');
                categoryImage.src = getCategoryImage(category, products); // ดึงรูปหมวดหมู่
                categoryImage.alt = category;
                categoryImage.classList.add('w-12', 'h-12', 'rounded-lg');

                const categoryLabel = document.createElement('span');
                categoryLabel.textContent = category === 'All' ? 'รวมทั้งหมด' : category; // เปลี่ยนชื่อเป็น "รวมทั้งหมด"
                categoryLabel.classList.add('text-sm');

                tabButton.appendChild(categoryImage);
                tabButton.appendChild(categoryLabel);
                tabButton.addEventListener('click', () => switchTab(category)); // เมื่อคลิกเปลี่ยนหมวดหมู่

                tabContainer.appendChild(tabButton);
            });

            tabNav.appendChild(tabContainer); // เพิ่มแท็บหมวดหมู่ลงในหน้าเว็บ
        }


        // ฟังก์ชันดึงรูปหมวดหมู่สินค้า
        function getCategoryImage(category, products) {
            if (category === 'All') {
                return 'https://via.placeholder.com/40?text=All'; // รูป Placeholder สำหรับหมวด 'All'
            }
            const product = products.find(p => p.category === category);
            return product ? product['img-product'] : 'https://via.placeholder.com/40?text=Other'; // รูป Placeholder สำหรับหมวดหมู่อื่นๆ
        }



        // ฟังก์ชันเปลี่ยนหมวดหมู่สินค้า
        function switchTab(category) {
            currentTab = category; // เปลี่ยนหมวดหมู่ปัจจุบัน
            currentPage = 0;
            const products = JSON.parse(localStorage.getItem('products'));
            renderProducts(products); // แสดงสินค้าตามหมวดหมู่ที่เลือก
            renderTabs(products); // แสดงแท็บใหม่
        }


        // ฟังก์ชันแสดงสินค้าตามหมวดหมู่
        function renderProducts(products) {
            productList.innerHTML = ''; // เคลียร์สินค้าก่อนหน้า
            const filteredProducts = currentTab === 'All' ? products : products.filter(product => product.category === currentTab);

            const productsToDisplay = filteredProducts.slice(0, (currentPage + 1) * productsPerPage); // แสดงสินค้าจำนวนที่กำหนด
            const catalogMap = new Map();

            productsToDisplay.forEach(product => {
                const catalog = product.category || 'Uncategorized';
                if (!catalogMap.has(catalog)) {
                    catalogMap.set(catalog, []);
                }
                catalogMap.get(catalog).push(product); // เพิ่มสินค้าลงในหมวดหมู่
            });

            catalogMap.forEach((items, catalog) => {
                const catalogSection = document.createElement('div');
                catalogSection.innerHTML = `
            <div class="grid grid-cols-2 gap-4 py-4">
                ${items.map(product => createProductHtml(product)).join('')}
            </div>
        `;
                productList.appendChild(catalogSection); // เพิ่มสินค้าในหมวดหมู่ลงในหน้าเว็บ
            });

            document.querySelectorAll('.add-to-cart').forEach(btn => {
                btn.addEventListener('click', addToCart); // เมื่อคลิกเพิ่มสินค้าลงตะกร้า
            });

            if (filteredProducts.length > productsToDisplay.length) {
                loadMoreContainer.classList.remove('hidden'); // แสดงปุ่ม "เพิ่มเติม" หากมีสินค้าเพิ่ม
            } else {
                loadMoreContainer.classList.add('hidden'); // ซ่อนปุ่ม "เพิ่มเติม" หากไม่มีสินค้าเพิ่ม
            }
        }


        // ฟังก์ชันสำหรับแสดงสินค้าด้วย HTML
        function createProductHtml(product) {
            let sizeOptions = ''; // ค่าเริ่มต้นเป็น "เลือกไซต์"
            const sizeKeys = ['available'];

            sizeKeys.forEach(size => {
                if (product[size] > 0) {
                    sizeOptions += `<option value="${size}">${size} (${product[size]})</option>`;
                }
            });

            if (!sizeOptions) {
                console.error("No sizes available for product:", product); // หากไม่มีขนาดที่พร้อมใช้งาน
                return ''; // หากไม่มีขนาดที่พร้อมใช้งาน ให้คืนค่าที่ว่างเปล่า
            }

            return `
        <div class="bg-white p-3 flex flex-col rounded-lg border border-yellow-400   relative">
            <div class="relative">
                <img src="${product['img-product']}" alt="${product.name}" class="w-full h-40 object-cover rounded-lg">
                <div class="absolute top-0 right-0 bg-green-500 text-white py-1  px-2 rounded-bl-lg rounded-tr-lg">
                    ${product.Price} บาท
                </div>
            </div>
            <div class="flex-grow text-left mt-2">
                <h3 class="text-md font-semibold text-gray-900">${product.name}</h3>
            </div>
            <div class="mt-2 flex justify-between items-center">
                <select class="bg-white p-1 rounded-lg product-size" data-id="${product.id}" style="width: 60%;display:none">  ${sizeOptions} </select>
                <button class="bg-yellow-200 text-black p-2 rounded-lg  focus:outline-none focus:ring-2 add-to-cart" data-id="${product.id}" style="width: 35%;">ซื้อ</button>
            </div>
        </div>
    `;
        }

        // ฟังก์ชันเพิ่มสินค้าลงตะกร้า
        function addToCart(event) {
            const productId = event.target.dataset.id;
            const products = JSON.parse(localStorage.getItem('products'));
            const product = products.find(p => p.id === productId);

            if (!product) {
                console.error(`Product with ID ${productId} not found.`); // หากไม่พบสินค้าตาม ID
                return;
            }

            const sizeElement = document.querySelector(`.product-size[data-id="${productId}"]`);
            if (!sizeElement) {
                console.error(`Size element not found for product ID: ${productId}`); // หากไม่พบข้อมูลขนาดสินค้า
                return;
            }

            const size = sizeElement.value.split(' ')[0]; // ดึงขนาดจาก dropdown
            if (!size) {
                sizeElement.style.border = "2px solid red"; // เปลี่ยน border ของ dropdown เป็นสีแดงเมื่อไม่ได้เลือกไซต์
                return;
            }

            sizeElement.style.border = ""; // รีเซ็ต border กลับเป็นปกติ

            const quantity = 1; // กำหนดค่าเริ่มต้นจำนวนเป็น 1

            if (product[size] < quantity) {
                alert('สินค้าในขนาดนี้หมดแล้ว'); // หากสินค้าหมด
                return;
            }

            product[size] -= quantity; // ลดจำนวนสินค้าใน stock

            const productInCart = cart.find(item => item.id === productId && item.size === size);
            if (productInCart) {
                productInCart.quantity += quantity; // หากสินค้ามีอยู่ในตะกร้าแล้ว ให้เพิ่มจำนวน
            } else {
                cart.push({ ...product, size, quantity }); // หากไม่มี ให้เพิ่มสินค้าลงในตะกร้า
            }

            updateCartCount(); // อัปเดตจำนวนสินค้าในตะกร้า
            renderProducts(products); // แสดงสินค้าพร้อมอัปเดตจำนวนใน stock
            // เรียกใช้เพื่อแสดงหรือซ่อนการส่งฟรี
            toggleFreeShippingOption();
            // แสดงอนิเมชั่นเมื่อเพิ่มสินค้าลงตะกร้า
            goToCartBtn.classList.add('added-to-cart');
            setTimeout(() => {
                goToCartBtn.classList.remove('added-to-cart');
            }, 500);
        }

        // ฟังก์ชันอัปเดตจำนวนสินค้าในตะกร้า
        function updateCartCount() {
            const cartCount = cart.reduce((total, item) => total + item.quantity, 0); // นับจำนวนสินค้าทั้งหมดในตะกร้า
            goToCartBtn.innerHTML = `  
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" color="#ffffff" fill="none">
            <path d="M11.5 8H20.196C20.8208 8 21.1332 8 21.3619 8.10084C22.3736 8.5469 21.9213 9.67075 21.7511 10.4784C21.7205 10.6235 21.621 10.747 21.4816 10.8132C20.9033 11.0876 20.4982 11.6081 20.3919 12.2134L19.7993 15.5878C19.5386 17.0725 19.4495 19.1943 18.1484 20.2402C17.1938 21 15.8184 21 13.0675 21H10.9325C8.18162 21 6.8062 21 5.8516 20.2402C4.55052 19.1942 4.46138 17.0725 4.20066 15.5878L3.60807 12.2134C3.50177 11.6081 3.09673 11.0876 2.51841 10.8132C2.37896 10.747 2.27952 10.6235 2.24894 10.4784C2.07874 9.67075 1.6264 8.5469 2.63812 8.10084C2.86684 8 3.17922 8 3.80397 8H7.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
            <path d="M14 12L10 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
            <path d="M6.5 11L10 3M15 3L17.5 8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
        </svg> ${cartCount}`;
        }

        // ฟังก์ชันเพื่อลบค่าจัดส่งเดิมออกจากตะกร้า
        function resetShippingCost() {
            // ลบค่าจัดส่งเก่าออกจากตะกร้า
            cart = cart.filter(item => item.id !== selectedShipping.id); // ลบค่าจัดส่งที่มี id เดียวกันออก
        }

        // ฟังก์ชันเพื่อตรวจสอบและเพิ่มค่าจัดส่งใหม่เมื่อแสดงตะกร้า
        function addShippingCost() {
            // ลบค่าจัดส่งเดิมก่อน
            resetShippingCost();

            // เพิ่มค่าจัดส่งใหม่ลงในตะกร้า
            if (selectedShipping.Price > 0) {
                cart.push({ ...selectedShipping, quantity: 1 }); // เพิ่มค่าจัดส่งลงในตะกร้า
            }
        }

        // เมื่อย้อนกลับไปยังหน้าร้านค้า ให้รีเซ็ตค่าจัดส่ง
        backToProductsBtn.addEventListener('click', () => {
            resetShippingCost(); // รีเซ็ตค่าจัดส่งออกจากตะกร้า
            cartView.classList.add('hidden');
            productSelection.classList.remove('hidden');
        });
        // เรียกใช้เมื่อแสดงตะกร้า
        function showCart() {
            productSelection.classList.add('hidden');
            cartView.classList.remove('hidden');
            renderCart(); // แสดงข้อมูลในตะกร้า
            toggleFreeShippingOption(); // ตรวจสอบการส่งฟรี
            updateTotalPrice(); // อัปเดตราคาและแสดง/ซ่อนปุ่ม 'ถัดไป'
        }


        // ฟังก์ชันการแสดงตะกร้าสินค้า
        function renderCart() {
            cartItems.innerHTML = ''; // เคลียร์รายการสินค้าก่อนหน้า
            cart.forEach((item, index) => {
                // ไม่แสดงค่าจัดส่งในรายการสินค้า
                if (item.id === selectedShipping.id) return;

                const cartItemEl = document.createElement('div');
                cartItemEl.classList.add('flex', 'items-center', 'justify-between', 'border-b', 'p-2');

                cartItemEl.innerHTML = `
            <img src="${item['img-product']}" alt="${item.name}" class="w-20 h-20  rounded-lg mr-4">
            <div class="flex-1">
                <h3 class="text-md font-semibold">${item.name}</h3>
                <p class="text-gray-600">${item.size}</p>
                <p class="text-gray-600 item-price" data-price="${item.Price}">${item.Price.toFixed(2)} บาท</p>
            </div>
            <div class="flex flex-col items-center">
                <button onclick="increment(${index})" class="bg-gray-200 rounded-lg w-7 h-7 flex items-center justify-center text-gray-600 font-bold pb-1 mb-1">+</button>
                <span class="w-8 text-center item-quantity">${item.quantity}</span>
                <button onclick="decrement(${index})" class="bg-gray-200 rounded-lg w-7 h-7 flex items-center justify-center text-gray-600 font-bold pb-1 mt-1">-</button>
            </div>
        `;
                cartItems.appendChild(cartItemEl); // แสดงสินค้าในตะกร้า
            });
            updateTotalPrice(); // อัปเดตราคารวม
        }

        // ฟังก์ชันเพิ่มจำนวนสินค้าในตะกร้า
        function increment(index) {
            const item = cart[index];
            const products = JSON.parse(localStorage.getItem('products')); // ดึงข้อมูลสินค้าจาก localStorage
            const product = products.find(p => p.id === item.id); // หา item ที่ตรงกับสินค้าในตะกร้า

            if (product[item.size] > item.quantity) {
                cart[index].quantity += 1;
                renderCart(); // แสดงตะกร้าหลังเพิ่มจำนวน
                updateCartCount(); // อัปเดตจำนวนสินค้าในตะกร้า
            }
        }

        // ฟังก์ชันลดจำนวนสินค้าในตะกร้า
        function decrement(index) {
            if (cart[index].quantity > 1) {
                cart[index].quantity -= 1;
            } else {
                cart.splice(index, 1); // ลบสินค้าหากจำนวนเป็น 0
            }
            renderCart(); // แสดงตะกร้าหลังลดจำนวน
            updateCartCount(); // อัปเดตจำนวนสินค้าในตะกร้า
        }

        // ฟังก์ชันอัปเดตราคารวมในตะกร้า
        function updateTotalPrice() {
            const productTotal = cart.reduce((total, item) => total + (item.Price * item.quantity), 0);
            const grandTotal = productTotal + selectedShipping.Price;

            // อัปเดตราคาใน HTML
            document.getElementById('total-price').textContent = `${productTotal.toFixed(2)} บาท`;
            document.getElementById('shipping-cost').textContent = `${selectedShipping.Price.toFixed(2)} บาท`;
            document.getElementById('grand-total').textContent = `${grandTotal.toFixed(2)} บาท`;

            // ตรวจสอบให้แน่ใจว่าปุ่ม 'ถัดไป' ถูกแสดงเมื่อมีสินค้าในตะกร้า
            const goToShippingBtn = document.getElementById('go-to-shipping');
            if (productTotal > 0) {
                goToShippingBtn.classList.remove('hidden'); // แสดงปุ่ม
            } else {
                goToShippingBtn.classList.add('hidden'); // ซ่อนปุ่ม
            }

            // ตรวจสอบตัวเลือกส่งฟรี
            toggleFreeShippingOption();
        }


        // ฟังก์ชันแสดงหรือซ่อนตัวเลือกการส่งฟรี
        function toggleFreeShippingOption() {
            const productTotal = cart.reduce((total, item) => total + (item.Price * item.quantity), 0); // คำนวณราคารวมสินค้า
            const freeShippingOption = document.querySelector('option[value="A00003"]'); // ตัวเลือกส่งฟรี

            if (productTotal >= 500) {
                freeShippingOption.style.display = 'block'; // แสดงตัวเลือกส่งฟรี
            } else {
                freeShippingOption.style.display = 'none'; // ซ่อนตัวเลือกส่งฟรี
                if (selectedShipping.id === 'A00003') {
                    // หากเลือกส่งฟรีไว้แล้ว แต่ยอดไม่ถึง 500 ให้รีเซ็ตการเลือกจัดส่ง
                    selectedShipping = shippingOptions[0]; // เปลี่ยนกลับเป็นค่าจัดส่งธรรมดา
                }
            }

            updateTotalPrice(); // อัปเดตราคารวมใหม่
        }




        // ฟังก์ชันแสดงข้อมูลจัดส่ง
        function showShippingInfo() {
            cartView.classList.add('hidden');
            shippingInfo.classList.remove('hidden');
        }

        // ฟังก์ชันย้อนกลับไปหน้าตะกร้า
        function backToCart() {
            shippingInfo.classList.add('hidden');
            cartView.classList.remove('hidden');
        }

        shippingForm.addEventListener('submit', handleShippingFormSubmit); // เมื่อส่งข้อมูลการจัดส่ง

        // ฟังก์ชันจัดการการส่งข้อมูลการจัดส่ง
        function handleShippingFormSubmit(event) {
            event.preventDefault(); // ป้องกันการส่งฟอร์มแบบเดิม
            const username = document.getElementById('username').value;
            const address = document.getElementById('address').value;
            const contact = document.getElementById('contact').value;
            const note = document.getElementById('note').value;
            const userlineid = document.getElementById('userlineid').value;
            const saveInfo = document.getElementById('save-info').checked;

            // ตรวจสอบและเพิ่มค่าจัดส่งก่อนบันทึกคำสั่งซื้อ
            addShippingCost(); // เพิ่มค่าจัดส่งที่ถูกต้องลงในตะกร้า

            // คำนวณราคารวมสินค้าและค่าจัดส่ง
            const productTotal = cart.reduce((total, item) => total + (item.Price * item.quantity), 0);
            const grandTotal = productTotal + selectedShipping.Price; // คำนวณราคารวมทั้งหมด

            // สร้างออเดอร์
            const order = {
                username,
                address,
                contact,
                note,
                userlineid,
                items: cart, // รายการสินค้าจากตะกร้า
                shippingType: selectedShipping.name, // ประเภทการจัดส่งที่เลือก
                shippingCost: selectedShipping.Price, // ค่าจัดส่งที่เลือก
                total: grandTotal, // ราคารวมสินค้า + ค่าจัดส่ง
                saveInfo
            };

            currentOrder = order; // บันทึกข้อมูลคำสั่งซื้อปัจจุบัน
            orderDetailsContent.innerHTML = renderOrderDetails(order); // แสดงรายละเอียดการสั่งซื้อ
            orderDetailsModal.classList.remove('hidden'); // แสดง modal รายละเอียดการสั่งซื้อ
        }


        // ฟังก์ชันแสดงรายละเอียดคำสั่งซื้อ
        function renderOrderDetails(order) {
            const itemsHtml = order.items.map(item => `
        <div class="flex justify-between items-center  my-2">
            <div>
                <p class="text-sm font-medium">${item.name} (${item.size})</p>
                <p class="text-xs text-gray-500">ราคา: ${item.Price} บาท</p>
                <p class="text-xs text-gray-500">จำนวน: ${item.quantity}</p>
            </div>
            <p class="text-sm">${(item.Price * item.quantity).toFixed(2)} บาท</p>
        </div>
    `).join('');

            return `
        <div>
            <p class="text-md font-semibold mb-2">ชื่อ: ${order.username}</p>
            <p class="text-md font-semibold mb-2">ที่อยู่จัดส่ง: ${order.address}</p>
            <p class="text-md font-semibold mb-2">เบอร์ติดต่อ: ${order.contact}</p>
            <p class="text-md font-semibold mb-2">ประเภทการจัดส่ง: ${order.shippingType}</p>
            <div class="border-t mt-4 pt-4">
                ${itemsHtml}
            </div>
            <div class="border-t mt-4 pt-4">
                <p class="text-lg font-semibold">ค่าจัดส่ง: ${order.shippingCost.toFixed(2)} บาท</p>
                <p class="text-lg font-semibold">ราคารวมทั้งหมด: ${order.total.toFixed(2)} บาท</p>
            </div>
        </div>
    `;
        }

        // ฟังก์ชันบันทึกคำสั่งซื้อ
        async function saveOrder(order) {
            orderStatusEl.classList.remove('hidden'); // แสดงข้อความสถานะการบันทึก
            orderStatusEl.textContent = 'กำลังบันทึกคำสั่งซื้อของคุณ...🛒';
            const response = await fetch(url, {
                method: 'POST',
                body: JSON.stringify(order) // ส่งข้อมูลคำสั่งซื้อไปยัง API
            });
            const result = await response.text();
            orderStatusEl.textContent = result; // แสดงข้อความผลลัพธ์การบันทึก
            console.log(result);
        }

        // กำหนดการทำงานให้ปุ่มต่างๆ
        goToCartBtn.addEventListener('click', showCart); // แสดงตะกร้าเมื่อคลิกที่ปุ่มตะกร้า
        backToProductsBtn.addEventListener('click', () => {
            cartView.classList.add('hidden'); // ซ่อนตะกร้า
            productSelection.classList.remove('hidden'); // แสดงรายการสินค้า
        });
        goToShippingBtn.addEventListener('click', showShippingInfo); // แสดงหน้าการจัดส่ง
        backToCartBtn.addEventListener('click', backToCart); // ย้อนกลับไปหน้าตะกร้า
        shippingForm.addEventListener('submit', handleShippingFormSubmit); // ส่งข้อมูลจัดส่ง
        confirmOrderBtn.addEventListener('click', async () => {
            await saveOrder(currentOrder); // บันทึกคำสั่งซื้อ
            cart = []; // เคลียร์ตะกร้าหลังบันทึก
            updateCartCount(); // อัปเดตจำนวนสินค้าในตะกร้า
            shippingInfo.classList.add('hidden'); // ซ่อนหน้าการจัดส่ง
            productSelection.classList.remove('hidden'); // แสดงหน้ารายการสินค้า
            orderDetailsModal.classList.add('hidden'); // ซ่อน modal รายละเอียดการสั่งซื้อ
            shippingForm.reset(); // ล้างข้อมูลฟอร์ม
            liff.closeWindow(); // ปิดหน้าต่าง LIFF
        });
        closeModalBtn.addEventListener('click', () => {
            orderDetailsModal.classList.add('hidden'); // ซ่อน modal เมื่อคลิกปุ่มปิด
        });


    </script>
    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
</body>

</html>
