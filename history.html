<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IIIRN-SHOP ระบบร้านค้า & แสดงข้อมูลการสั่งซื้อ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11" defer></script>
    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js" defer></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" defer></script>
</head>

<body class="bg-slate-300">
    <!-- Product Selection -->
    <div id="product-selection" class="max-w-md mx-auto pt-20">
        <div class="fixed top-0 left-0 w-full bg-white shadow z-50">
            <div class="flex justify-between items-center p-4">
                <div class="flex items-center">
                    <div class="w-12 h-12 rounded-lg items-center">
                        <img src="https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png"
                            alt="Profile Image" id="profileImage" class="w-12 h-12 bg-white rounded-lg">
                    </div>
                    <div class="pl-4">
                        <p class="text-slate-400 text-xs">ยินดีต้อนรับ</p>
                        <input type="text" class="input-field bg-slate-800 w-32 text-slate-800 text-lg font-bold bg-opacity-0" id="displayName" name="displayName" readonly>
                    </div>
                </div>
                <div class="flex items-center">
                <div class="w-12 h-12 rounded-lg items-center">
                <img src="https://lh5.googleusercontent.com/d/17VYrYx47MjT67L3nQ_PUsiABUPN00DjX" alt="Profile Image"  class="w-12 h-12 bg-white rounded-lg">
                </div>
            </div>
        </div>
    </div>

    <input type="hidden" id="userlineid" name="userlineid">

    <!-- ตารางแสดงข้อมูลที่ดึงจาก Google Sheets -->
    <div class="max-w-md m-auto p-4">
        <table id="data-table" class="min-w-full text-xs bg-white rounded-md">
            <thead>
                <tr class="text-slate-800 text-sm mt-4">
                    <th class="py-2 px-4 border-b">ออเดอร์</th>
                    <th class="py-2 px-4 border-b">ราคา</th>
                    <th class="py-2 px-4 border-b">เวลาสั่งซื้อ</th>
                    <th class="py-2 px-4 border-b">บิล</th>
                </tr>
            </thead>
            <tbody class="text-sm">
                <!-- ข้อมูลจะถูกเพิ่มที่นี่โดย JavaScript -->
            </tbody>
        </table>

        <!-- Pagination -->
        <div id="pagination" class="flex justify-center mt-4"></div>
        <div id="loading-message" class="text-center text-gray-500 mb-4" style="display: none;">กำลังโหลดรายการ...</div>
    </div>

    <script>
        const WEB_MEMBER_APP_URL = 'https://script.google.com/macros/s/AKfycbzmglQHTa1C7i3Dvm_xZnCKm0DiqB2Y2QjAlJIw-UEHTCI4XuEFH3kZCGQm2nd3xEc/exec';
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxiBmdJ7JNSiUcebGh-ws8APKjEGOaF_-QWUMNvW4heozkxL4rg4REkHwdVLYgmAEQqYA/exec';
        const LIFF_ID = '2001192277-lO2ONg1W'; 
        const ROWS_PER_PAGE = 15;
        let currentPage = 1;
        let tableData = [];
        let filteredData = [];

        window.onload = () => initializeLiff();

        async function initializeLiff() {
            try {
                await liff.init({ liffId: `${LIFF_ID}` });
                liff.isLoggedIn() ? await handleLoggedInUser() : liff.login();
            } catch (error) {
                console.error('Error initializing LIFF:', error);
            }
        }

        async function handleLoggedInUser() {
            await getUserProfile();
            await fetchData();
        }

        async function getUserProfile() {
            try {
                const profile = await liff.getProfile();
                document.getElementById('userlineid').value = profile.userId;
                document.getElementById('displayName').value = profile.displayName;
                document.getElementById('profileImage').src = profile.pictureUrl || 'https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png';
                await fetchUserPoints(profile.userId);
            } catch (error) {
                console.error('Error getting profile data:', error);
            }
        }

        async function fetchUserPoints(userId) {
            try {
                const response = await fetch(WEB_MEMBER_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'fetchData', userId })
                });
                const data = await response.json();
                data ? displayPoints(data.Points) : console.log('No data found for userId:', userId);
            } catch (error) {
                console.error('Error fetching points:', error);
            }
        }

        function displayPoints(points) {
            document.getElementById('userPoints').innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" color="#000000" fill="none">
                    <path d="M22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22C17.5228 22 22 17.5228 22 12Z" stroke="currentColor" stroke-width="1.5" />
                    <path d="M12.8638 7.72209L13.7437 9.49644C13.8637 9.74344 14.1837 9.98035 14.4536 10.0257L16.0485 10.2929C17.0684 10.4643 17.3083 11.2103 16.5734 11.9462L15.3335 13.1964C15.1236 13.4081 15.0086 13.8164 15.0736 14.1087L15.4285 15.6562C15.7085 16.8812 15.0636 17.355 13.9887 16.7148L12.4939 15.8226C12.2239 15.6613 11.7789 15.6613 11.504 15.8226L10.0091 16.7148C8.93925 17.355 8.28932 16.8761 8.56929 15.6562L8.92425 14.1087C8.98925 13.8164 8.87426 13.4081 8.66428 13.1964L7.42442 11.9462C6.6945 11.2103 6.92947 10.4643 7.94936 10.2929L9.54419 10.0257C9.80916 9.98035 10.1291 9.74344 10.2491 9.49644L11.129 7.72209C11.609 6.7593 12.3889 6.7593 12.8638 7.72209Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                </svg> ${points || 0}`;
        }

        async function fetchData() {
            document.getElementById('loading-message').style.display = 'block';
            try {
                const userId = document.getElementById('userlineid').value;
                const response = await fetch(WEB_APP_URL);
                const data = await response.json();
                tableData = processOrders(data.slice(1));
                filteredData = tableData.filter(order => order.userId === userId);
                applyFilters();
            } catch (error) {
                console.error('Error fetching data:', error);
                Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: 'ไม่สามารถโหลดข้อมูลได้' });
            } finally {
                document.getElementById('loading-message').style.display = 'none';
            }
        }

        function processOrders(data) {
            const orderMap = {};
            data.forEach(row => {
                const [orderId, name, address, contact, note, userId, , , , , totalOrder, totalPrice, rawTimestamp] = row;
                const timestamp = new Date(rawTimestamp);

                if (!orderMap[orderId]) {
                    orderMap[orderId] = { orderId, userId, name, address, contact,note, totalOrder: +totalOrder, totalPrice: +totalPrice, timestamp, products: [] };
                } else {
                    orderMap[orderId].totalOrder += +totalOrder;
                    orderMap[orderId].totalPrice += +totalPrice;
                }

                orderMap[orderId].products.push({ productId: row[6], product: row[7], price: row[8], size: row[9], value: row[10],express: row[12], totalOrder: +totalOrder });
            });
            return Object.values(orderMap);
        }

        function applyFilters() {
            filteredData.sort((a, b) => b.timestamp - a.timestamp);
            currentPage = 1;
            displayTable(filteredData);
            renderPagination(filteredData.length);
        }

        function displayTable(data) {
            const tableBody = document.querySelector('#data-table tbody');
            tableBody.innerHTML = '';
            const paginatedData = data.slice((currentPage - 1) * ROWS_PER_PAGE, currentPage * ROWS_PER_PAGE);
            paginatedData.forEach(order => {
                tableBody.insertAdjacentHTML('beforeend', `
                    <tr>
                        <td class="py-2 px-4 border-b">${order.orderId}</td>
                        <td class="py-2 px-4 border-b">${order.totalPrice.toFixed(2)}</td>
                        <td class="py-2 px-4 border-b">${formatDate(order.timestamp)}</td>
                        <td class="py-2 px-4 border-b">
                            <button class="bg-blue-500 text-white py-1 px-3 rounded hover:bg-blue-700" onclick="showDetails('${order.orderId}')">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" color="#ffffff" fill="none">
                                    <path d="M8 7L16 7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                                    <path d="M8 11L12 11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                                    <path d="M13 21.5V21C13 18.1716 13 16.7574 13.8787 15.8787C14.7574 15 16.1716 15 19 15H19.5M20 13.3431V10C20 6.22876 20 4.34315 18.8284 3.17157C17.6569 2 15.7712 2 12 2C8.22877 2 6.34315 2 5.17157 3.17157C4 4.34314 4 6.22876 4 10L4 14.5442C4 17.7892 4 19.4117 4.88607 20.5107C5.06508 20.7327 5.26731 20.9349 5.48933 21.1139C6.58831 22 8.21082 22 11.4558 22C12.1614 22 12.5141 22 12.8372 21.886C12.9044 21.8623 12.9702 21.835 13.0345 21.8043C13.3436 21.6564 13.593 21.407 14.0919 20.9081L18.8284 16.1716C19.4065 15.5935 19.6955 15.3045 19.8478 14.9369C20 14.5694 20 14.1606 20 13.3431Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                            </button>
                        </td>
                    </tr>
                `);
            });
        }

        function renderPagination(totalRows) {
            const totalPages = Math.ceil(totalRows / ROWS_PER_PAGE);
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            const maxPages = 3;
            const startPage = Math.max(1, currentPage - 1);
            const endPage = Math.min(totalPages, startPage + maxPages - 1);
            if (startPage > 1) addPaginationButton('Prev', startPage - 1);
            for (let i = startPage; i <= endPage; i++) {
                addPaginationButton(i, i === currentPage ? i : i);
            }
            if (endPage < totalPages) addPaginationButton('Next', endPage + 1);
        }

        function addPaginationButton(text, page) {
            const pagination = document.getElementById('pagination');
            const button = document.createElement('button');
            button.className = `mx-1 px-3 py-1 rounded ${page === currentPage ? 'bg-blue-500 text-white' : 'bg-gray-300'}`;
            button.innerText = text;
            button.onclick = () => {
                currentPage = page;
                displayTable(filteredData);
                renderPagination(filteredData.length);
            };
            pagination.appendChild(button);
        }

        function formatDate(isoString) {
            const date = new Date(isoString);
            return `${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth() + 1).padStart(2, '0')}/${date.getFullYear()} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
        }

        function showDetails(orderId) {
            const order = tableData.find(order => order.orderId === orderId);
            if (!order) {
                Swal.fire({ icon: 'error', title: 'ไม่พบข้อมูล', text: `ไม่พบข้อมูลสำหรับ Order ID: ${orderId}` });
                return;
            }
            let productDetails = `
                <div style="margin-bottom: 10px; font-size:14px; text-align: start;">
                    <strong>ข้อมูลการสั่งซื้อ</strong>
                    <p><strong>Order ID:</strong> ${order.orderId}</p>
                    <p><strong>ชื่อผู้สั่ง:</strong> ${order.name}</p>
                    <p><strong>ที่อยู่:</strong> ${order.address}</p>
                    <p><strong>เบอร์ติดต่อ:</strong> ${order.contact}</p>
                    <p><strong>หมายเหตุ:</strong> ${order.note}</p>

                </div>
                <div style="margin-bottom: 10px; font-size:14px; text-align: start;">
                    <strong>รายการสินค้า</strong>
                </div>`;
            order.products.forEach(product => {
                productDetails += `
                    <div style="margin-bottom: 10px;font-size:14px;text-align: start;">
                        <div style="display: flex; justify-content: space-between;">
                            <div style="flex: 1; padding-right: 10px;">
                                <p><strong>สินค้า:</strong> ${product.product}</p>
                                <p><strong>ราคา:</strong> ${product.price} บาท</p>
                            </div>
                            <div style="flex: 1; padding-left: 10px;">
                                <p><strong>ไซต์:</strong> ${product.size}</p>
                                <p><strong>จำนวน:</strong> ${product.totalOrder} ชิ้น</p>

                            </div>
                        </div>
                    </div>`;
            });
            productDetails += `
                <div style="margin-top: 20px; font-size:14px; text-align: start;">
                    <strong>รวมเป็นเงิน:</strong> ${order.totalPrice.toFixed(2)} บาท
                </div>
                <div style="margin-top: 10px; font-size:14px; text-align: start;">
                    <strong>เวลาสั่งซื้อ:</strong> ${formatDate(order.timestamp)}
                </div>
                 <div style="margin-top: 10px; font-size:14px; text-align: start;">
                    <strong>เวลาสั่งจัดส่ง:</strong> ${formatDate(product.express)}
                </div>`;
            Swal.fire({ title: `<div class="text-sm">รายละเอียดบิล Order ${orderId}</div>`, html: productDetails, confirmButtonText: 'ปิด' });
        }
    </script>
</body>

</html>
