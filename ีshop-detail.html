
<!DOCTYPE html>
<html lang="en">

<head>
    <!-- ส่วนหัวของหน้าเว็บ -->
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IIIRN SHOP</title>
    <!-- ฟอนต์ภาษาไทย -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai&display=swap" rel="stylesheet">
    <!-- สไตล์สำหรับ Swiper.js -->
    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css" />
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com" defer></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10" defer></script>
    <!-- Swiper.js -->
    <script src="https://unpkg.com/swiper/swiper-bundle.min.js" defer></script>

    <style>
        /* สไตล์เพิ่มเติม */
        @keyframes go-to-cart {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.2);
            }

            100% {
                transform: scale(1);
            }
        }

        .go-to-cart {
            animation: go-to-cart 0.5s ease-in-out;
            background-color: #4caf50;
            transform: scale(1.1);
        }

        @keyframes loading-text {
            0% {
                content: "โหลด..รายการสินค้า";
            }

            33% {
                content: "โหลด...รายการสินค้า";
            }

            66% {
                content: "โหลด....รายการสินค้า";
            }

            100% {
                content: "โหลด.....รายการสินค้า";
            }
        }

        .loading-animation::after {
            content: "โหลด..รายการสินค้า";
            animation: loading-text 1.5s infinite;
            color: #FFFFFF;
			text-align:center;
			width:100%
        }

		/* สไตล์สำหรับ Swiper */
		.swiper-container {
			width: 100%;
			max-width: 400px;
			max-height: 300px;
			position: relative;
		}

		.swiper-slide {
			display: flex; /* ใช้ flexbox เพื่อจัดการวางตำแหน่ง */
			justify-content: center; /* จัดรูปภาพให้อยู่ตรงกลางในแนวนอน */
			align-items: center; /* จัดรูปภาพให้อยู่ตรงกลางในแนวตั้ง */
			height: 100%; /* ให้ swiper-slide ใช้ความสูงเต็มที่ */
		}

		.swiper-slide img {
			width: 100%;
			max-width: 300px; /* ความกว้างสูงสุดของรูปภาพ */
			height: auto; /* ให้ความสูงปรับอัตโนมัติตามสัดส่วนของภาพ */
			object-fit: cover; /* ให้รูปภาพปรับขนาดตาม container โดยไม่บิดเบือน */
		}

        .swiper-button-prev-custom,
        .swiper-button-next-custom {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgb(147 147 147 / 50%);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            font-size: 20px;
            padding-bottom: 5px;
            border-radius: 25%;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }

        .swiper-button-prev-custom {
            left: 10px;
        }

        .swiper-button-next-custom {
            right: 10px;
        }

        .swiper-pagination {
            bottom: 10px !important;
        }

        .custom-swal-popup {
            padding: 0 !important;
        }

        .swal2-popup {
            overflow: hidden !important;
        }

        button.swal2-confirm.swal2-styled {
            display: none !important;
        }

        .swal2-title {
            font-size: 1rem !important;
        }
    </style>
</head>

<body class="bg-gradient-to-b from-slate-600 to-slate-300 min-h-screen">
    <!-- ฟังก์ชันการแสดงรายการสินค้า -->
    <div id="product-selection" class="max-w-md mx-auto pt-20">
        <div class="p-4 rounded-xl">
            <!-- ส่วนหัวของร้านค้า -->
            <div class="fixed top-0 left-0 w-full bg-white border border-t-slate-300 shadow z-50">
                <div class="flex justify-between items-center p-4">
                    <div class="flex items-center">
                        <div class="w-12 h-12 rounded-xl items-center">
                            <img src="https://via.placeholder.com/40?text=PROFILE" alt="Profile Image" id="profileImage"
                                class="w-12 h-12 bg-white rounded-xl">
                        </div>
                        <div class="pl-4">
                            <p class="text-slate-800 text-xs">ยินดีต้อนรับ</p>
                            <input type="text"
                                class="input-field bg-slate-800 w-32 text-slate-800 text-lg font-bold bg-opacity-0"
                                id="displayName" name="displayName" readonly>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <p class="bg-lime-200 mx-1 rounded-xl w-full max-w-24 p-2 text-slate-800 text-md font-bold flex items-center gap-2"
                            id="userPoints">
                            <!-- ไอคอนคะแนน -->
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"
                                color="#000000" fill="none">
                                <path
                                    d="M22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22C17.5228 22 22 17.5228 22 12Z"
                                    stroke="currentColor" stroke-width="1.5" />
                                <path
                                    d="M12.8638 7.72209L13.7437 9.49644C13.8637 9.74344 14.1837 9.98035 14.4536 10.0257L16.0485 10.2929C17.0684 10.4643 17.3083 11.2103 16.5734 11.9462L15.3335 13.1964C15.1236 13.4081 15.0086 13.8164 15.0736 14.1087L15.4285 15.6562C15.7085 16.8812 15.0636 17.355 13.9887 16.7148L12.4939 15.8226C12.2239 15.6613 11.7789 15.6613 11.504 15.8226L10.0091 16.7148C8.93925 17.355 8.28932 16.8761 8.56929 15.6562L8.92425 14.1087C8.98925 13.8164 8.87426 13.4081 8.66428 13.1964L7.42442 11.9462C6.6945 11.2103 6.92947 10.4643 7.94936 10.2929L9.54419 10.0257C9.80916 9.98035 10.1291 9.74344 10.2491 9.49644L11.129 7.72209C11.609 6.7593 12.3889 6.7593 12.8638 7.72209Z"
                                    stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                                    stroke-linejoin="round" />
                            </svg>
                            0
                        </p>
                        <button id="go-to-cart"
                            class="bg-slate-800 text-white text-md py-2 px-4 flex items-center gap-2 rounded-xl ml-4">
                            <!-- ไอคอนตะกร้าสินค้า -->
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"
                                color="#ffffff" fill="none">
                                <path
                                    d="M11.5 8H20.196C20.8208 8 21.1332 8 21.3619 8.10084C22.3736 8.5469 21.9213 9.67075 21.7511 10.4784C21.7205 10.6235 21.621 10.747 21.4816 10.8132C20.9033 11.0876 20.4982 11.6081 20.3919 12.2134L19.7993 15.5878C19.5386 17.0725 19.4495 19.1943 18.1484 20.2402C17.1938 21 15.8184 21 13.0675 21H10.9325C8.18162 21 6.8062 21 5.8516 20.2402C4.55052 19.1942 4.46138 17.0725 4.20066 15.5878L3.60807 12.2134C3.50177 11.6081 3.09673 11.0876 2.51841 10.8132C2.37896 10.747 2.27952 10.6235 2.24894 10.4784C2.07874 9.67075 1.6264 8.5469 2.63812 8.10084C2.86684 8 3.17922 8 3.80397 8H7.5"
                                    stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
                                <path d="M14 12L10 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                                    stroke-linejoin="round" />
                                <path d="M6.5 11L10 3M15 3L17.5 8" stroke="currentColor" stroke-width="1.5"
                                    stroke-linecap="round" />
                            </svg>
                            0
                        </button>
                    </div>
                </div>
            </div>

            <div>
                <!-- ส่วนแสดงหมวดหมู่สินค้า -->
                <div class="flex">
                    <div id="tab-nav" class="flex overflow-x-auto space-x-4 py-2">
                        <!-- หมวดหมู่สินค้า -->
                    </div>
                </div>
                <!-- ช่องค้นหาสินค้า -->
                <div class="relative ">
                    <input type="text" id="search-input" placeholder="ค้นหาสินค้า"
                        class="w-full px-4 py-2 border rounded-xl ">
                </div>
                <!-- รายการสินค้า -->
                <div id="product-list" class="text-center grid grid-cols-2 gap-4 py-4">
                </div>
                <!-- ปุ่มโหลดเพิ่มเติม -->
                <div id="load-more-container" class="text-center m-4 hidden">
                    <button id="load-more" class="bg-white px-4 py-2 rounded-xl">เพิ่มเติม</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ฟังก์ชันการแสดงตะกร้าสินค้า -->
    <div id="cart-view" class="max-w-md mx-auto pt-20 hidden">
        <div class="bg-white rounded-xl p-4 m-2">
            <!-- ส่วนหัวของตะกร้าสินค้า -->
            <div class="fixed top-0 left-0 w-full bg-white border border-t-slate-800 shadow-md z-50">
                <div class="flex justify-between items-center p-4">
                    <h2 class="text-md font-semibold">ตะกร้าสินค้า</h2>
                    <div id="back-to-products"
                        class="bg-white opacitywhite text-center font-bold py-2 w-36 border rounded-xl">กลับ ร้านค้า
                    </div>
                </div>
            </div>

            <div id="cart-items" class="bg-white rounded-xl"></div>

            <div class="pt-4">
                <div class="flex justify-between items-center mb-4">
                    <label for="shipping-options" class="text-sm">การจัดส่ง</br>
                        <span class="text-slate-800 text-xs" style="float:inline-end;">ส่งฟรี(ซื้อครบ 500 บาท)</span>
                    </label>
                    <select id="shipping-options" class="bg-white border border-gray-400 rounded-xl p-2">
                        <option value="A00000">จัดส่งปกติ(50)</option>
                        <option value="A00001">ส่งด่วน(80)</option>
                        <option value="A00002">ส่งขนส่ง(120)</option>
                    </select>
                </div>

                <div class="flex justify-between items-center mb-4">
                    <span class="text-md font-semibold">ค่าจัดส่ง</span>
                    <span id="shipping-cost" class="text-md text-gray-400">5.00 บาท</span>
                </div>
                <div class="flex justify-between items-center mb-4">
                    <span class="text-md font-semibold">ราคารวมสินค้า</span>
                    <span id="total-price" class="text-md text-gray-400">0.00 บาท</span>
                </div>

                <div class="flex justify-between items-center mb-4">
                    <span class="text-md font-semibold">ราคารวมทั้งหมด</span>
                    <span id="grand-total" class="text-lg text-amber-600 font-semibold">0.00 บาท</span>
                </div>
            </div>

            <button id="go-to-shipping"
                class="w-full bg-slate-800 text-white p-4 rounded-xl font-semibold hidden">ถัดไป</button>
        </div>
    </div>

    <!-- ฟังก์ชันการแสดงข้อมูลจัดส่ง -->
    <div id="shipping-info" class="max-w-md mx-auto pt-20 hidden">
        <div class="p-4">
            <!-- ส่วนหัวของการจัดส่ง -->
            <div class="fixed top-0 left-0 w-full bg-white border border-t-slate-800 z-50">
                <div class="flex justify-between items-center p-4">
                    <h2 class="text-md font-semibold">การจัดส่ง</h2>
                    <button id="back-to-cart"
                        class="bg-white opacitywhite text-center font-bold py-2 w-36 border rounded-xl">กลับ
                        ตะกร้าสินค้า</button>
                </div>
            </div>
            <form id="shipping-form">
                <div id="loading-container">
                    <div id="loading-icon"></div>
                    <div class="text-center">กำลังค้นหารายชื่อ...</div>
                </div>
                <div id="form-container">
                    <div class="mb-4">
                        <label for="username" class="block text-gray-100">ชื่อ:</label>
                        <input type="text" id="username" placeholder="Name"
                            class="block w-full mb-2 p-2 border rounded-xl" required />
                    </div>
                    <div class="mb-4">
                        <label for="contact" class="block text-gray-100">เบอร์ติดต่อ:</label>
                        <input type="text" id="contact" placeholder="Contact"
                            class="block w-full mb-2 p-2 border rounded-xl" required />
                    </div>
                    <div class="mb-4">
                        <label for="address" class="block text-gray-100">ที่อยู่:</label>
                        <textarea id="address" placeholder="Address" class="block w-full mb-2 p-2 border rounded-xl"
                            style="height: 150px;" required></textarea>
                    </div>
                    <div class="mb-4">
                        <label for="note" class="block text-gray-100">หมายเหตุ:</label>
                        <textarea id="note" placeholder="Contact"
                            class="block w-full mb-2 p-2 border rounded-xl" style="height: 100px;"></textarea>
                    </div>

                    <div class="mb-4">
                        <input type="checkbox" id="save-info" class="mr-2">
                        <label for="save-info"
                            class="text-gray-100">บันทึกชื่อและที่อยู่สำหรับการใช้งานครั้งถัดไป</label>
                    </div>
                    <input type="hidden" id="userlineid" name="userlineid">
                </div>
                <button type="submit" class="bg-slate-950 text-white p-4 w-full rounded-xl mt-4">สั่งซื้อสินค้า</button>
            </form>
        </div>
    </div>

    <!-- ฟังก์ชันแสดงรายละเอียดการสั่งซื้อ -->
    <div id="order-details-modal" class="fixed z-10 inset-0 overflow-y-auto hidden">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
            </div>
            <div class="rounded-xl overflow-hidden transform transition-all w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">รายละเอียดสั่งซื้อ</h3>
                    <div class="mt-2">
                        <div id="order-details-content" class="bg-gray-100 p-4 rounded-xl"></div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button id="confirm-order"
                        class="w-full inline-flex justify-center rounded-xl border border-transparent px-4 py-4 bg-slate-800 text-base font-medium text-white hover:bg-slate-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-800 sm:ml-3 sm:w-auto sm:text-sm">ยืนยันการสั่งซื้อ</button>
                    <button id="close-modal"
                        class="mt-3 w-full inline-flex justify-center rounded-xl border border-gray-300 px-4 py-2 bg-white text-base font-medium text-black hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:w-auto sm:text-sm">ยกเลิก</button>
                    <div id="order-status" class="px-4 py-3 sm:px-6 text-center text-sm hidden"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- สคริปต์หลัก -->
    <script>
        // ฟังก์ชันตั้งค่า
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyuz1I1AaFIpEtKlQuQNld9ue8BHbKzlPy5YQXpAeyomC979SYd0-jpzhthUF456ctxGw/exec";
        const WEB_MEMBER_APP_URL = 'https://script.google.com/macros/s/AKfycbwUj-dHVIxyjvudRS0cykoLTNx_8mLYC6zlSyamLjQP_rD2bTM1BFCtnvFOPYeDCzOBxw/exec';
        // Liff ID
        const LIFF_ID = '2005629952-POXR9wLQ';

        // ตัวเลือกการจัดส่ง
        const shippingOptions = [
            {
                id: 'A00000',
                name: 'ส่งปกติ',
                Price: 50,
                size: 'ส่งปกติ',
                quantity: 1,
                'img-product': 'https://via.placeholder.com/40?text=Ship'
            },
            {
                id: 'A00001',
                name: 'ส่งด่วน',
                Price: 80,
                size: 'ส่งด่วน',
                quantity: 1,
                'img-product': 'https://via.placeholder.com/40?text=Express'
            },
            {
                id: 'A00002',
                name: 'ส่งบริการขนส่ง',
                Price: 120,
                size: 'บริการขนส่ง',
                quantity: 1,
                'img-product': 'https://via.placeholder.com/40?text=Transport'
            },
            {
                id: 'A00003',
                name: 'ส่งฟรี(ขั้นต่ำ 500)',
                Price: 0,
                size: 'ฟรี',
                quantity: 1,
                'img-product': 'https://via.placeholder.com/40?text=Free'
            }
        ];

        // ตั้งค่าการจัดส่งเริ่มต้น
        let selectedShipping = shippingOptions[0];

        // ตัวแปรหลัก
        let cart = [];
        let currentOrder = null;
        let currentTab = 'All';
        let currentPage = 0;
        const productsPerPage = 10;
        let isSearching = false;
        let filteredProducts = [];
        let productsCache = [];

        // การเข้าถึง DOM
        const productList = document.getElementById('product-list');
        const tabNav = document.getElementById('tab-nav');
        const goToCartBtn = document.getElementById('go-to-cart');
        const cartView = document.getElementById('cart-view');
        const productSelection = document.getElementById('product-selection');
        const backToProductsBtn = document.getElementById('back-to-products');
        const cartItems = document.getElementById('cart-items');
        const totalPriceEl = document.getElementById('total-price');
        const goToShippingBtn = document.getElementById('go-to-shipping');
        const shippingInfo = document.getElementById('shipping-info');
        const backToCartBtn = document.getElementById('back-to-cart');
        const shippingForm = document.getElementById('shipping-form');
        const orderDetailsModal = document.getElementById('order-details-modal');
        const orderDetailsContent = document.getElementById('order-details-content');
        const confirmOrderBtn = document.getElementById('confirm-order');
        const closeModalBtn = document.getElementById('close-modal');
        const orderStatusEl = document.getElementById('order-status');
        const loadMoreBtn = document.getElementById('load-more');
        const loadMoreContainer = document.getElementById('load-more-container');

        // ฟังก์ชันเริ่มต้นเมื่อ DOM โหลดเสร็จ
        document.addEventListener('DOMContentLoaded', async function () {
            await initializeLiff(); // เรียกใช้งาน LIFF
            fetchProducts(); // ดึงข้อมูลสินค้า
        });

        // ฟังก์ชันเริ่มต้นการใช้งาน LIFF
        async function initializeLiff() {
            try {
                await liff.init({ liffId: `${LIFF_ID}` }); // ใช้ Liff ID ของคุณ
                if (liff.isLoggedIn()) {
                    showLoading(true); // แสดงหน้าจอโหลดข้อมูล
                    getUserProfile(); // ดึงข้อมูลโปรไฟล์ผู้ใช้
                } else {
                    liff.login(); // หากผู้ใช้ยังไม่ได้เข้าสู่ระบบให้เข้าสู่ระบบ
                }
            } catch (error) {
                console.error('Error initializing LIFF:', error); // แสดงข้อผิดพลาดถ้า LIFF เริ่มต้นไม่สำเร็จ
            }
        }

        // ฟังก์ชันสำหรับดึงข้อมูลโปรไฟล์ผู้ใช้
        async function getUserProfile() {
            try {
                const profile = await liff.getProfile(); // ดึงข้อมูลโปรไฟล์ผู้ใช้
                const userId = profile.userId;
                document.getElementById('userlineid').value = userId; // เก็บค่า user ID
                document.getElementById('displayName').value = profile.displayName;
                document.getElementById('profileImage').src = profile.pictureUrl || 'https://via.placeholder.com/40?text=PROFILE';

                await fetchData(userId); // เรียกใช้ฟังก์ชันดึงข้อมูล
            } catch (error) {
                console.error('Error getting profile data:', error); // หากเกิดข้อผิดพลาดในการดึงข้อมูลโปรไฟล์
            } finally {
                showLoading(false); // ซ่อนหน้าจอโหลดข้อมูลเมื่อเสร็จสิ้น
            }
        }

        // ฟังก์ชันดึงข้อมูลจาก API
        async function fetchData(userId) {
            try {
                const response = await fetch(WEB_MEMBER_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'fetchData', userId: userId }) // ส่ง userId เพื่อดึงข้อมูล
                });
                const data = await response.json();

                // ตรวจสอบข้อมูลที่ดึงมา
                console.log('Data fetched:', data);

                if (data) { // หากมีข้อมูลให้แสดง
                    displayData(data);
                } else {
                    console.log('No data found for userId:', userId); // หากไม่พบข้อมูล
                }
            } catch (error) {
                console.error('Error fetching data:', error); // แสดงข้อผิดพลาดหากการดึงข้อมูลล้มเหลว
            }
        }

        // ฟังก์ชันแสดงข้อมูลผู้ใช้
        function displayData(row) {
            console.log('Displaying data:', row);

            document.getElementById('username').value = row.Name || ''; // ชื่อผู้ใช้
            document.getElementById('address').value = row.Address || '';  // ที่อยู่
            document.getElementById('contact').value = row.Contact || '';  // เบอร์ติดต่อ
        }

        // ฟังก์ชันแสดงหน้าจอโหลดข้อมูล
        function showLoading(isLoading) {
            const loadingContainer = document.getElementById('loading-container');
            const formContainer = document.getElementById('form-container');
            if (isLoading) {
                loadingContainer.style.display = 'block'; // แสดงการโหลดข้อมูล
                formContainer.style.display = 'none'; // ซ่อนฟอร์มข้อมูล
            } else {
                loadingContainer.style.display = 'none'; // ซ่อนการโหลดข้อมูล
                formContainer.style.display = 'block'; // แสดงฟอร์มข้อมูล
            }
        }

        // ฟังก์ชันสำหรับค้นหาสินค้า
        document.getElementById('search-input').addEventListener('input', debounce(searchProducts, 300));

        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        function searchProducts() {
            currentPage = 0; // รีเซ็ตหน้าปัจจุบันเมื่อค้นหาใหม่
            const query = document.getElementById('search-input').value.toLowerCase();
            if (query) {
                isSearching = true;
                filteredProducts = productsCache.filter(product => product.name.toLowerCase().includes(query));
            } else {
                isSearching = false;
                filteredProducts = [];
            }
            renderProducts(productsCache); // เรียกใช้ฟังก์ชันแสดงสินค้า
        }

        // ฟังก์ชันดึงข้อมูลสินค้า
        async function fetchProducts() {
            const loadingText = document.createElement('div');
            loadingText.className = 'loading-animation text-md pt-4 text-slate-800';
            productList.appendChild(loadingText);

            try {
                const response = await fetch(WEB_APP_URL);
                const products = await response.json();

                if (!products || products.length === 0) {
                    console.error("No products data received."); // หากไม่พบข้อมูลสินค้า
                    return;
                }

                productsCache = products; // เก็บข้อมูลสินค้าในตัวแปร
                renderProducts(productsCache); // แสดงสินค้าบนหน้าเว็บ
                renderTabs(productsCache); // แสดงหมวดหมู่
            } catch (error) {
                console.error('Error fetching products:', error); // แสดงข้อผิดพลาดหากเกิดข้อผิดพลาด
            } finally {
                productList.removeChild(loadingText); // เอาข้อความโหลดออกเมื่อเสร็จสิ้น
            }
        }

        // ฟังก์ชันแสดงแท็บหมวดหมู่สินค้า
        function renderTabs(products) {
            tabNav.innerHTML = ''; // เคลียร์แท็บเดิม
            let categories = [...new Set(products.map(product => product.category || 'Uncategorized'))];

            // ใส่หมวดหมู่ 'All' ไว้เป็นตัวเลือกแรกเสมอ
            categories = ['All', ...categories.filter(category => category !== 'All')];

            const tabContainer = document.createElement('div');
            tabContainer.classList.add('flex', 'space-x-4', 'overflow-x-auto', 'py-2');

            categories.forEach(category => {
                const tabButton = document.createElement('button');
                tabButton.classList.add('flex-shrink-0', 'px-1', 'py-1', 'pr-2', 'rounded-xl', 'focus:outline-none', 'flex', 'items-center', 'justify-start', 'space-x-2');
                tabButton.setAttribute('data-category', category);

                if (category === currentTab) {
                    tabButton.classList.add('active', 'bg-lime-200', 'text-black');
                } else {
                    tabButton.classList.add('bg-white');
                }
                const categoryImage = document.createElement('img');
                categoryImage.src = getCategoryImage(category, products);
                categoryImage.alt = category;
                categoryImage.classList.add('w-12', 'h-12', 'rounded-lg');

                const categoryLabel = document.createElement('span');
                categoryLabel.textContent = category === 'All' ? 'รวมทั้งหมด' : category;
                categoryLabel.classList.add('text-sm');

                tabButton.appendChild(categoryImage);
                tabButton.appendChild(categoryLabel);
                tabButton.addEventListener('click', () => switchTab(category));

                tabContainer.appendChild(tabButton);
            });

            tabNav.appendChild(tabContainer);
        }

        // ฟังก์ชันดึงรูปหมวดหมู่สินค้า
        function getCategoryImage(category, products) {
            if (category === 'All') {
                return 'https://via.placeholder.com/40?text=All';
            }
            const product = products.find(p => p.category === category);
            return product ? product['img-product'] : 'https://via.placeholder.com/40?text=Other';
        }

        // ฟังก์ชันเปลี่ยนหมวดหมู่สินค้า
        function switchTab(category) {
            currentTab = category; // เปลี่ยนหมวดหมู่ปัจจุบัน
            currentPage = 0; // รีเซ็ตหน้าปัจจุบัน
            isSearching = false; // รีเซ็ตสถานะการค้นหา
            filteredProducts = [];
            document.getElementById('search-input').value = ''; // ล้างช่องค้นหา
            renderProducts(productsCache); // แสดงสินค้าตามหมวดหมู่
            renderTabs(productsCache); // แสดงแท็บใหม่
        }

        // ฟังก์ชันแสดงสินค้าตามหมวดหมู่
        function renderProducts(products, append = false) {
            if (!append) {
                productList.innerHTML = ''; // เคลียร์รายการสินค้าก่อนหน้า
            }

            let filtered = [];
            if (isSearching) {
                filtered = filteredProducts;
            } else {
                filtered = currentTab === 'All' ? products : products.filter(product => product.category === currentTab);
            }

            const startIndex = currentPage * productsPerPage;
            const endIndex = (currentPage + 1) * productsPerPage;

            const productsToDisplay = filtered.slice(startIndex, endIndex);

            const fragment = document.createDocumentFragment();

            productsToDisplay.forEach(product => {
                const productElement = createProductElement(product);
                fragment.appendChild(productElement);
            });

            productList.appendChild(fragment);

            if (filtered.length > endIndex) {
                loadMoreContainer.classList.remove('hidden');
            } else {
                loadMoreContainer.classList.add('hidden');
            }
        }

        // ฟังก์ชันสร้างองค์ประกอบสินค้า
        function createProductElement(product) {
            const productDiv = document.createElement('div');
            productDiv.classList.add('bg-slate-100', 'p-3', 'flex', 'flex-col', 'rounded-xl', 'border', 'relative');

            const imgContainer = document.createElement('div');
            imgContainer.classList.add('relative');

            const productImg = document.createElement('img');
            productImg.src = product['img-product'];
            productImg.alt = product.name;
            productImg.classList.add('w-full', 'h-40', 'object-cover', 'rounded-xl', 'product-img');
            productImg.setAttribute('data-id', product.id);

            imgContainer.appendChild(productImg);

            const priceTag = document.createElement('div');
            priceTag.classList.add('absolute', 'top-0', 'right-0', 'bg-slate-800', 'text-white', 'py-1', 'px-2', 'rounded-bl-lg', 'rounded-tr-lg');
            priceTag.textContent = `${product.Price} บาท`;
            imgContainer.appendChild(priceTag);

            productDiv.appendChild(imgContainer);

            const productInfo = document.createElement('div');
            productInfo.classList.add('flex-grow', 'text-left', 'mt-2');

            const productName = document.createElement('h3');
            productName.classList.add('text-md', 'font-semibold', 'text-gray-900');
            productName.textContent = product.name;

            productInfo.appendChild(productName);
            productDiv.appendChild(productInfo);

            const actionContainer = document.createElement('div');
            actionContainer.classList.add('mt-2', 'flex', 'justify-between', 'items-center');

            const sizeSelect = document.createElement('select');
            sizeSelect.classList.add('bg-white', 'border', 'border-slate-800', 'py-2', 'rounded-xl', 'product-size');
            sizeSelect.setAttribute('data-id', product.id);

            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.disabled = true;
            defaultOption.selected = true;
            defaultOption.textContent = 'เลือกไซต์';

            sizeSelect.appendChild(defaultOption);

            ['FS', 'S', 'M', 'L', 'XL', 'XXL'].forEach(size => {
                if (product[size] > 0) {
                    const option = document.createElement('option');
                    option.value = size;
                    option.textContent = `${size} (${product[size]})`;
                    sizeSelect.appendChild(option);
                }
            });

            actionContainer.appendChild(sizeSelect);

            const addToCartBtn = document.createElement('button');
            addToCartBtn.classList.add('bg-lime-200', 'text-black', 'p-2', 'rounded-xl', 'focus:outline-none', 'focus:ring-2', 'add-to-cart');
            addToCartBtn.style.width = '35%';
            addToCartBtn.textContent = 'ซื้อ';
            addToCartBtn.setAttribute('data-id', product.id);

            actionContainer.appendChild(addToCartBtn);

            productDiv.appendChild(actionContainer);

            return productDiv;
        }

        // ฟังก์ชันเพิ่มสินค้าในตะกร้า
        document.addEventListener('click', function (event) {
            if (event.target.classList.contains('add-to-cart')) {
                addToCart(event);
            }

            if (event.target.classList.contains('product-img')) {
                const productId = event.target.dataset.id;
                const product = productsCache.find(p => p.id === productId);

                if (product) {
                    showProductDetails(product);
                }
            }
        });

        function addToCart(event) {
            const productId = event.target.dataset.id;
            const product = productsCache.find(p => p.id === productId);

            if (!product) {
                console.error(`Product with ID ${productId} not found.`);
                return;
            }

            const sizeElement = document.querySelector(`.product-size[data-id="${productId}"]`);
            if (!sizeElement) {
                console.error(`Size element not found for product ID: ${productId}`);
                return;
            }

            const size = sizeElement.value;
            if (!size) {
                sizeElement.style.border = "1px solid red";
                return;
            }

            sizeElement.style.border = "";

            const quantity = 1;

            if (product[size] < quantity) {
                alert('สินค้าในขนาดนี้หมดแล้ว');
                return;
            }

            product[size] -= quantity;

            const productInCart = cart.find(item => item.id === productId && item.size === size);
            if (productInCart) {
                productInCart.quantity += quantity;
            } else {
                cart.push({ ...product, size, quantity });
            }

            updateCartCount();

            // รีเซ็ตคลาสก่อนการเพิ่มใหม่เพื่อให้อนิเมชันทำงาน
            goToCartBtn.classList.remove('go-to-cart');
            void goToCartBtn.offsetWidth;
            goToCartBtn.classList.add('go-to-cart');

            setTimeout(() => {
                goToCartBtn.classList.remove('go-to-cart');
            }, 500);
        }

        // ฟังก์ชันอัปเดตจำนวนสินค้าในตะกร้า
        function updateCartCount() {
            const cartCount = cart.reduce((total, item) => total + item.quantity, 0);
            goToCartBtn.innerHTML = `
                <!-- ไอคอนตะกร้าสินค้า -->
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" color="#ffffff" fill="none">
                    <path d="M11.5 8H20.196C20.8208 8 21.1332 8 21.3619 8.10084C22.3736 8.5469 21.9213 9.67075 21.7511 10.4784C21.7205 10.6235 21.621 10.747 21.4816 10.8132C20.9033 11.0876 20.4982 11.6081 20.3919 12.2134L19.7993 15.5878C19.5386 17.0725 19.4495 19.1943 18.1484 20.2402C17.1938 21 15.8184 21 13.0675 21H10.9325C8.18162 21 6.8062 21 5.8516 20.2402C4.55052 19.1942 4.46138 17.0725 4.20066 15.5878L3.60807 12.2134C3.50177 11.6081 3.09673 11.0876 2.51841 10.8132C2.37896 10.747 2.27952 10.6235 2.24894 10.4784C2.07874 9.67075 1.6264 8.5469 2.63812 8.10084C2.86684 8 3.17922 8 3.80397 8H7.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
                    <path d="M14 12L10 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M6.5 11L10 3M15 3L17.5 8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
                </svg> ${cartCount}`;
        }

        // ฟังก์ชันแสดงตะกร้าสินค้า
        function showCart() {
            productSelection.classList.add('hidden');
            cartView.classList.remove('hidden');
            renderCart();
            toggleFreeShippingOption();
            updateTotalPrice();
        }

        // ฟังก์ชันการแสดงตะกร้าสินค้า
        function renderCart() {
            cartItems.innerHTML = '';
            cart.forEach((item, index) => {
                if (item.id === selectedShipping.id) return;

                const cartItemEl = document.createElement('div');
                cartItemEl.classList.add('flex', 'items-center', 'justify-between', 'border-b', 'p-2');

                cartItemEl.innerHTML = `
                    <img src="${item['img-product']}" alt="${item.name}" class="w-20 h-20 rounded-xl mr-4">
                    <div class="flex-1">
                        <h3 class="text-md font-semibold">${item.name}</h3>
                        <p class="text-gray-600">ขนาด: ${item.size}</p>
                        <p class="text-gray-600 item-price" data-price="${item.Price}">${item.Price.toFixed(2)} บาท</p>
                    </div>
                    <div class="flex flex-col items-center">
                        <button onclick="increment(${index})" class="bg-gray-200 rounded-xl w-7 h-7 flex items-center justify-center text-gray-600 font-bold pb-1 mb-1">+</button>
                        <span class="w-8 text-center item-quantity">${item.quantity}</span>
                        <button onclick="decrement(${index})" class="bg-gray-200 rounded-xl w-7 h-7 flex items-center justify-center text-gray-600 font-bold pb-1 mt-1">-</button>
                    </div>
                `;
                cartItems.appendChild(cartItemEl);
            });
            updateTotalPrice();
        }

        // ฟังก์ชันเพิ่มจำนวนสินค้าในตะกร้า
        function increment(index) {
            const item = cart[index];
            const product = productsCache.find(p => p.id === item.id);

            if (product[item.size] > item.quantity) {
                cart[index].quantity += 1;
                renderCart();
                updateCartCount();
            }
        }

        // ฟังก์ชันลดจำนวนสินค้าในตะกร้า
        function decrement(index) {
            if (cart[index].quantity > 1) {
                cart[index].quantity -= 1;
            } else {
                cart.splice(index, 1);
            }
            renderCart();
            updateCartCount();
        }

        // ฟังก์ชันอัปเดตราคารวม
        function updateTotalPrice() {
            const productTotal = cart.reduce((total, item) => total + (item.Price * item.quantity), 0);
            const shippingDropdown = document.getElementById('shipping-options');

            selectedShipping = shippingOptions.find(option => option.id === shippingDropdown.value);

            if (selectedShipping.id === 'A00000' && productTotal < 500) {
                selectedShipping.Price = 50;
            } else if (productTotal >= 500 && selectedShipping.id === 'A00000') {
                selectedShipping.Price = 0;
            }

            const grandTotal = productTotal + (selectedShipping.Price || 0);

            document.getElementById('total-price').textContent = `${productTotal.toFixed(2)} บาท`;
            document.getElementById('shipping-cost').textContent = `${selectedShipping.Price.toFixed(2)} บาท`;
            document.getElementById('grand-total').textContent = `${grandTotal.toFixed(2)} บาท`;

            if (productTotal > 0) {
                goToShippingBtn.classList.remove('hidden');
            } else {
                goToShippingBtn.classList.add('hidden');
            }
        }

        // เพิ่ม event listener ให้ dropdown
        document.getElementById('shipping-options').addEventListener('change', function () {
            updateTotalPrice();
        });

        // ฟังก์ชันแสดงหรือซ่อนตัวเลือกการส่งฟรี
        function toggleFreeShippingOption() {
            const productTotal = cart.reduce((total, item) => total + (item.Price * item.quantity), 0);
            const freeShippingOption = document.querySelector('option[value="A00003"]');

            if (productTotal >= 500) {
                freeShippingOption.style.display = 'block';
            } else {
                freeShippingOption.style.display = 'none';
                if (selectedShipping.id === 'A00003') {
                    selectedShipping = shippingOptions[0];
                }
            }

            updateTotalPrice();
        }

        // ฟังก์ชันเพิ่มค่าจัดส่งใหม่ลงในตะกร้า
        function addShippingCost() {
            resetShippingCost();
            cart.push({ ...selectedShipping, quantity: 1 });
        }

        // ฟังก์ชันเพื่อลบค่าจัดส่งเดิมออกจากตะกร้า
        function resetShippingCost() {
            cart = cart.filter(item => !shippingOptions.some(option => option.id === item.id));
        }

        // เมื่อย้อนกลับไปยังหน้าร้านค้า ให้รีเซ็ตค่าจัดส่ง
        backToProductsBtn.addEventListener('click', () => {
            resetShippingCost();
            selectedShipping = shippingOptions[0];
            document.getElementById('shipping-options').value = selectedShipping.id;
            cartView.classList.add('hidden');
            productSelection.classList.remove('hidden');
        });

        // ฟังก์ชันแสดงข้อมูลจัดส่ง
        function showShippingInfo() {
            cartView.classList.add('hidden');
            shippingInfo.classList.remove('hidden');
        }

        // ฟังก์ชันย้อนกลับไปหน้าตะกร้า
        function backToCart() {
            shippingInfo.classList.add('hidden');
            cartView.classList.remove('hidden');
        }

        // ฟังก์ชันจัดการเมื่อส่งฟอร์มการจัดส่ง
        shippingForm.addEventListener('submit', handleShippingFormSubmit);

        function handleShippingFormSubmit(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const address = document.getElementById('address').value;
            const contact = document.getElementById('contact').value;
            const note = document.getElementById('note').value;
            const userlineid = document.getElementById('userlineid').value;
            const saveInfo = document.getElementById('save-info').checked;

            addShippingCost();

            const productTotal = cart.reduce((total, item) => total + (item.Price * item.quantity), 0);
            const grandTotal = productTotal + (selectedShipping.Price || 0);

            const order = {
                username,
                address,
                contact,
                note,
                userlineid,
                items: cart,
                shippingType: selectedShipping.name,
                shippingCost: selectedShipping.Price !== undefined ? selectedShipping.Price : 0,
                total: grandTotal,
                saveInfo
            };

            currentOrder = order;
            orderDetailsContent.innerHTML = renderOrderDetails(order);
            orderDetailsModal.classList.remove('hidden');
        }

        // ฟังก์ชันบันทึกคำสั่งซื้อ
        async function saveOrder(order) {
            orderStatusEl.classList.remove('hidden');
            orderStatusEl.textContent = 'กำลังบันทึกคำสั่งซื้อของคุณ...🛒';

            try {
                const productTotal = order.items.reduce((total, item) => total + (item.Price * item.quantity), 0);

                const newOrder = {
                    ...order,
                    total: productTotal,
                    shippingCost: order.shippingCost
                };

                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify(newOrder)
                });
                const result = await response.text();
                orderStatusEl.textContent = result;
                console.log(result);
            } catch (error) {
                console.error('Error saving order:', error);
                orderStatusEl.textContent = 'เกิดข้อผิดพลาดในการบันทึกคำสั่งซื้อ';
            }
        }

        // ฟังก์ชันสำหรับแสดงรายละเอียดสินค้าและรูปภาพเพิ่มเติมใน SweetAlert
        function showProductDetails(product) {
            const formattedDetail = product.deatail.replace(/\n/g, '<br>');

            const imageSlides = `
                <div id="product-carousel" class="swiper-container" style="position: relative;">
                    <div class="swiper-wrapper">
                        <div class="swiper-slide">
                            <img src="${product['img-product']}" alt="${product.name}" class="swiper-image" style="width: 100%; height: 200px; object-fit: cover;">
                        </div>
                        <div class="swiper-slide">
                            <img src="${product['more-pic1']}" alt="${product.name} 1" class="swiper-image" style="width: 100%; height: 200px; object-fit: cover;">
                        </div>
                        <div class="swiper-slide">
                            <img src="${product['more-pic2']}" alt="${product.name} 2" class="swiper-image" style="width: 100%; height: 200px; object-fit: cover;">
                        </div>
                        <div class="swiper-slide">
                            <img src="${product['more-pic3']}" alt="${product.name} 3" class="swiper-image" style="width: 100%; height: 200px; object-fit: cover;">
                        </div>
                    </div>
                    <div class="swiper-pagination"></div>
                    <!-- ปุ่มควบคุม -->
                    <button class="swiper-button-prev-custom">⟨</button>
                    <button class="swiper-button-next-custom">⟩</button>
                </div>
                <p class="text-left text-sm p-4 mt-4">${formattedDetail}</p>
            `;

            Swal.fire({
                title: product.name,
                html: imageSlides,
                showCloseButton: true,
                focusConfirm: false,
                didOpen: () => {
                    const swiper = new Swiper('.swiper-container', {
                        loop: true,
                        slidesPerView: 1,
                        spaceBetween: 10,
                        pagination: {
                            el: '.swiper-pagination',
                            clickable: true,
                        },
                        navigation: {
                            nextEl: '.swiper-button-next-custom',
                            prevEl: '.swiper-button-prev-custom',
                        },
                        autoplay: {
                            delay: 3000,
                        },
                        touchEventsTarget: 'wrapper',
                        touchRatio: 1.5,
                        allowTouchMove: true,
                    });
                },
            });
        }

        // ฟังก์ชันแสดงรายละเอียดคำสั่งซื้อ
        function renderOrderDetails(order) {
            const itemsHtml = order.items.map(item => `
                <div class="flex justify-between items-center my-2">
                    <div>
                        <p class="text-sm font-medium">${item.name} (${item.size})</p>
                        <p class="text-xs text-gray-500">ราคา: ${item.Price} บาท</p>
                        <p class="text-xs text-gray-500">จำนวน: ${item.quantity}</p>
                    </div>
                    <p class="text-sm">${(item.Price * item.quantity).toFixed(2)} บาท</p>
                </div>
            `).join('');

            const productTotal = order.items.reduce((total, item) => total + (item.Price * item.quantity), 0);

            return `
                <div>
                    <p class="text-md font-semibold mb-2">ชื่อ: ${order.username}</p>
                    <p class="text-md font-semibold mb-2">ที่อยู่จัดส่ง: ${order.address}</p>
                    <p class="text-md font-semibold mb-2">เบอร์ติดต่อ: ${order.contact}</p>
                    <p class="text-md font-semibold mb-2">ประเภทการจัดส่ง: ${order.shippingType}</p>
                    <div class="border-t mt-4 pt-4">
                        ${itemsHtml}
                    </div>
                    <div class="border-t mt-4 pt-4">
                        <p class="text-lg font-semibold">ราคารวมทั้งหมด: ${productTotal.toFixed(2)} บาท</p>
                    </div>
                </div>
            `;
        }

        // กำหนดการทำงานให้ปุ่มต่างๆ
        goToCartBtn.addEventListener('click', showCart);
        backToProductsBtn.addEventListener('click', () => {
            cartView.classList.add('hidden');
            productSelection.classList.remove('hidden');
        });
        goToShippingBtn.addEventListener('click', showShippingInfo);
        backToCartBtn.addEventListener('click', backToCart);
        shippingForm.addEventListener('submit', handleShippingFormSubmit);
        confirmOrderBtn.addEventListener('click', async () => {
            await saveOrder(currentOrder);
            await sendTextMessage();

            cart = [];
            updateCartCount();
            shippingInfo.classList.add('hidden');
            productSelection.classList.remove('hidden');
            orderDetailsModal.classList.add('hidden');
            shippingForm.reset();
            liff.closeWindow();
        });
        closeModalBtn.addEventListener('click', () => {
            orderDetailsModal.classList.add('hidden');
        });

        // ฟังก์ชันส่งข้อความแจ้งเตือนทาง LINE
        async function sendTextMessage() {
            try {
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                await liff.sendMessages([
                    {
                        'type': 'text',
                        'text': `รายการสั่งซื้อสำเร็จ`
                    }
                ]);
                console.log('Message sent successfully');
            } catch (error) {
                console.error('Error sending message:', error);
            }
        }

        // ฟังก์ชันโหลดเพิ่มเติม
        loadMoreBtn.addEventListener('click', () => {
            currentPage += 1;
            renderProducts(productsCache, true);
        });
    </script>
    <!-- LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
</body>

</html>
